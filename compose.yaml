# =============================================================================
# TRICOUNT API DOWNLOADER
# =============================================================================
# 
# Cette stack cr√©e une API REST pour t√©l√©charger les transactions Tricount en CSV
#
# INSTALLATION :
# 1. Copiez ce fichier dans Dockge
# 2. Cliquez sur "Deploy" ou "Start"
# 3. Attendez 1-2 minutes que tout s'installe
# 4. Testez que l'API fonctionne : http://192.168.1.30:5000/health
#
# UTILISATION AVEC INTERFACE WEB :
# 1. Ouvrez votre navigateur sur : http://192.168.1.30:5000
# 2. Entrez votre cl√© Tricount dans le formulaire
# 3. Cliquez sur "T√©l√©charger"
# 4. Le CSV se t√©l√©charge automatiquement !
#
# UTILISATION VIA API DIRECTE :
# http://192.168.1.30:5000/download?tricount_key=VOTRE_CLE
#
# PORT : 5000 (modifiable ci-dessous si n√©cessaire)
# =============================================================================

services:
  tricount-api:
    image: python:3.11-slim
    container_name: tricount-api
    restart: unless-stopped
    ports:
      - "5000:5000"
    working_dir: /app
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        apt-get update && apt-get install -y git
        git clone https://github.com/MrNachoX/tricount-downloader.git /app/tricount-downloader 2>/dev/null || true
        cd /app/tricount-downloader
        pip install -r requirements.txt
        pip install flask flask-cors
        
        mkdir -p /app/templates
        cat > /app/templates/index.html << 'HTMLEOF'
        <!DOCTYPE html>
        <html lang="fr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Tricount Downloader</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                .container {
                    background: white;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    padding: 40px;
                    max-width: 500px;
                    width: 100%;
                }
                h1 { color: #667eea; margin-bottom: 10px; font-size: 32px; text-align: center; }
                .subtitle { color: #666; text-align: center; margin-bottom: 30px; font-size: 14px; }
                .form-group { margin-bottom: 20px; }
                label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
                input[type="text"] {
                    width: 100%;
                    padding: 14px;
                    border: 2px solid #e0e0e0;
                    border-radius: 10px;
                    font-size: 16px;
                    transition: all 0.3s;
                }
                input[type="text"]:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                }
                button {
                    width: 100%;
                    padding: 14px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 10px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: transform 0.2s, box-shadow 0.2s;
                }
                button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
                button:active { transform: translateY(0); }
                button:disabled { opacity: 0.6; cursor: not-allowed; }
                .help-text { margin-top: 8px; font-size: 12px; color: #666; }
                .help-text a { color: #667eea; text-decoration: none; }
                .help-text a:hover { text-decoration: underline; }
                .message {
                    margin-top: 20px;
                    padding: 12px;
                    border-radius: 8px;
                    font-size: 14px;
                    display: none;
                }
                .message.error { background: #fee; color: #c33; border: 1px solid #fcc; }
                .message.success { background: #efe; color: #3c3; border: 1px solid #cfc; }
                .loader { display: none; text-align: center; margin-top: 20px; }
                .spinner {
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid #667eea;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto;
                }
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                .example { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 13px; }
                .example strong { color: #667eea; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìä Tricount Downloader</h1>
                <p class="subtitle">Exportez vos transactions en CSV</p>
                
                <form id="downloadForm">
                    <div class="form-group">
                        <label for="tricountKey">Cl√© Tricount</label>
                        <input type="text" id="tricountKey" name="tricount_key" placeholder="tISWyMCgrIMgFuxudZ" required>
                        <div class="help-text">
                            Trouvez votre cl√© dans l'URL de partage Tricount<br>
                            Exemple : tricount.com/<strong>tISWyMCgrIMgFuxudZ</strong>
                        </div>
                    </div>
                    <button type="submit" id="submitBtn">üì• T√©l√©charger le CSV</button>
                </form>
                
                <div class="loader" id="loader">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">T√©l√©chargement en cours...</p>
                </div>
                
                <div class="message" id="message"></div>
                
                <div class="example">
                    <strong>üí° Comment obtenir votre cl√© ?</strong><br>
                    1. Ouvrez votre Tricount sur <a href="https://tricount.com" target="_blank">tricount.com</a><br>
                    2. Cliquez sur "Partager"<br>
                    3. Copiez la partie apr√®s "tricount.com/"
                </div>
            </div>

            <script>
                const form = document.getElementById('downloadForm');
                const submitBtn = document.getElementById('submitBtn');
                const loader = document.getElementById('loader');
                const message = document.getElementById('message');
                const input = document.getElementById('tricountKey');

                function showMessage(text, type) {
                    message.textContent = text;
                    message.className = 'message ' + type;
                    message.style.display = 'block';
                    setTimeout(() => { message.style.display = 'none'; }, 5000);
                }

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const tricountKey = input.value.trim();
                    if (!tricountKey) { showMessage('Veuillez entrer une cl√© Tricount', 'error'); return; }

                    submitBtn.disabled = true;
                    submitBtn.textContent = '‚è≥ T√©l√©chargement...';
                    loader.style.display = 'block';
                    message.style.display = 'none';

                    try {
                        const response = await fetch('/download?tricount_key=' + encodeURIComponent(tricountKey));
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Erreur lors du t√©l√©chargement');
                        }

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'tricount-' + tricountKey + '.csv';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        showMessage('‚úÖ T√©l√©chargement r√©ussi !', 'success');
                    } catch (error) {
                        showMessage('‚ùå Erreur : ' + error.message, 'error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'üì• T√©l√©charger le CSV';
                        loader.style.display = 'none';
                    }
                });
            </script>
        </body>
        </html>
        HTMLEOF
        
        cat > /app/api.py << 'PYEOF'
        from flask import Flask, request, send_file, jsonify, render_template
        from flask_cors import CORS
        import subprocess
        import os
        import glob
        import re

        app = Flask(__name__)
        CORS(app)

        @app.route('/')
        def index():
            return render_template('index.html')

        @app.route('/download', methods=['GET'])
        def download_tricount():
            tricount_key = request.args.get('tricount_key')
            if not tricount_key:
                return jsonify({'error': 'tricount_key parameter required'}), 400
            
            try:
                os.chdir('/app/tricount-downloader')
                
                with open('main.py', 'r') as f:
                    content = f.read()
                
                content = re.sub(r'tricount_key = ["\'].*?["\']', 
                               f'tricount_key = "{tricount_key}"', content)
                
                with open('main.py', 'w') as f:
                    f.write(content)
                
                result = subprocess.run(['python', 'main.py'], 
                                      capture_output=True, text=True, timeout=60)
                
                csv_files = glob.glob('/app/tricount-downloader/Transactions*.csv')
                if not csv_files:
                    return jsonify({
                        'error': 'No CSV generated', 
                        'output': result.stdout, 
                        'stderr': result.stderr
                    }), 500
                
                latest_csv = max(csv_files, key=os.path.getctime)
                
                return send_file(latest_csv, as_attachment=True, 
                               download_name=f'tricount-{tricount_key}.csv',
                               mimetype='text/csv')
                
            except Exception as e:
                import traceback
                return jsonify({'error': str(e), 'traceback': traceback.format_exc()}), 500

        @app.route('/health', methods=['GET'])
        def health():
            return jsonify({'status': 'ok'})

        if __name__ == '__main__':
            app.run(host='0.0.0.0', port=5000)
        PYEOF
        python /app/api.py
    volumes:
      - tricount-data:/app
    networks:
      - tricount-net

networks:
  tricount-net:
    driver: bridge

volumes:
  tricount-data:
